<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MOB - HistÃ³rico Mensal</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #004AAD;
    margin: 0;
    padding: 20px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
    box-sizing: border-box;
  }
  h1 {
    text-align: center;
    color: #ffffff;
  }
  label {
    font-weight: bold;
  }
  select, input[type="number"] {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    margin-bottom: 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    box-sizing: border-box;
  }
  button {
    padding: 8px 14px;
    font-size: 15px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin: 4px 2px;
  }
  button:hover {
    background: #2980b9;
  }
  .btn-limpar {
    background: #e74c3c;
  }
  .card {
    background: white;
    padding: 15px 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(18, 101, 255, 0.466);
  }
  .progress-bar {
    width: 100%;
    background: #ddd;
    height: 24px;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 10px;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #2ecc71, #27ae60);
    width: 0;
    transition: width 0.4s ease;
  }
  .resumo {
    font-size: 18px;
    text-align: center;
  }
  .list-section {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 6px 10px;
    background: #fafafa;
  }
  .list-section h4 {
    margin: 5px 0;
  }
  .list-section ul {
    padding-left: 20px;
    margin: 0;
  }
  .list-section li {
    font-size: 14px;
    margin-bottom: 4px;
  }

  @media (max-width: 500px) {
    body {
      max-width: 100%;
      padding: 15px 10px;
    }
    h1 {
      font-size: 24px;
    }
    input[type="number"], select {
      font-size: 18px;
    }
    button {
      font-size: 17px;
      padding: 12px 20px;
    }
    .card {
      padding: 12px 15px;
    }
    .list-section {
      max-height: 120px;
      padding: 8px 10px;
    }
  }

  .logo-container {
  text-align: center;
  margin-bottom: 15px;
}

.logo-container img {
  max-width: 180px; /* ajusta o tamanho mÃ¡ximo da logo */
  width: 60%;
  height: auto;
  object-fit: contain;
}
</style>
</head>
<body>
<div class="logo-container">
  <img src="./MOB.png" alt="Logo MOB" />
</div>

<h1>MOB - Control de corridas</h1>

<div class="card">
  <label for="selectMes">Selecionar MÃªs/Ano:</label>
  <select id="selectMes"></select>
</div>

<div class="card">
  <label for="metaMes">Definir Meta do MÃªs (R$):</label>
  <input type="number" id="metaMes" min="0" step="0.01" placeholder="Ex: 3000" />
</div>

<div class="card">
  <label for="valorDia">Adicionar Valor do Dia (R$):</label>
  <input type="number" id="valorDia" min="0" step="0.01" placeholder="Ex: 100" />
  <button id="btnAdicionar">+ Adicionar Ganho</button>
</div>

<div class="card">
  <label for="gastoGasolina">Adicionar Gasto com Gasolina (R$):</label>
  <input type="number" id="gastoGasolina" min="0" step="0.01" placeholder="Ex: 100" />
  <button id="btnAdicionarGasto">+ Adicionar Gasto</button>
</div>

<div class="card resumo">
  <p><strong>Total Ganho no MÃªs:</strong> R$ <span id="totalGanhos">0.00</span></p>
  <p><strong>Total Gasto com Gasolina:</strong> R$ <span id="totalGastos">0.00</span></p>
  <p><strong>Lucro LÃ­quido:</strong> R$ <span id="lucroLiquido">0.00</span></p>
  <p><strong>Meta do MÃªs:</strong> R$ <span id="metaExibida">0.00</span></p>
  <p><strong>Dias Trabalhados:</strong> <span id="diasTrabalhados">0</span></p>
  <p><strong>Progresso:</strong> <span id="progressoPercent">0%</span></p>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<div class="card list-section">
  <h4>Ganhos DiÃ¡rios</h4>
  <ul id="listaGanhos"></ul>
</div>

<div class="card list-section">
  <h4>Gastos com Gasolina</h4>
  <ul id="listaGastos"></ul>
</div>

<div class="card" style="text-align:center;">
  <button id="btnExportar">ðŸ“¤ Exportar Dados CSV</button>
  <button id="btnLimpar" class="btn-limpar">ðŸ§¹ Limpar Dados do MÃªs</button>
</div>

<script>
  const selectMes = document.getElementById('selectMes');
  const metaInput = document.getElementById('metaMes');
  const valorDiaInput = document.getElementById('valorDia');
  const btnAdicionar = document.getElementById('btnAdicionar');
  const gastoGasolinaInput = document.getElementById('gastoGasolina');
  const btnAdicionarGasto = document.getElementById('btnAdicionarGasto');
  const btnLimpar = document.getElementById('btnLimpar');
  const btnExportar = document.getElementById('btnExportar');

  const totalGanhosSpan = document.getElementById('totalGanhos');
  const totalGastosSpan = document.getElementById('totalGastos');
  const lucroLiquidoSpan = document.getElementById('lucroLiquido');
  const metaExibidaSpan = document.getElementById('metaExibida');
  const diasTrabalhadosSpan = document.getElementById('diasTrabalhados');
  const progressoPercentSpan = document.getElementById('progressoPercent');
  const progressFillDiv = document.getElementById('progressFill');

  const listaGanhosUl = document.getElementById('listaGanhos');
  const listaGastosUl = document.getElementById('listaGastos');

  // Estrutura de dados por mÃªs:
  // { meta: number, ganhos: [{valor, data}], gastos: [{valor, data}] }
  let dadosMes = { meta: 0, ganhos: [], gastos: [] };
  let notificouMeta = false;

  // Pega a data atual formatada YYYY-MM para inicializar
  function getMesAtual() {
    const d = new Date();
    return d.toISOString().slice(0,7);
  }

  // Lista meses existentes no localStorage
  function listarMeses() {
    const meses = [];
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith("mob_")) {
        meses.push(key.slice(4));
      }
    }
    return meses.sort().reverse();
  }

  // Preenche o dropdown com os meses disponÃ­veis + atual se nÃ£o existir
  function popularSelectMes() {
    const meses = listarMeses();
    const mesAtual = getMesAtual();
    if(!meses.includes(mesAtual)) meses.unshift(mesAtual);
    selectMes.innerHTML = "";
    meses.forEach(m => {
      const option = document.createElement("option");
      option.value = m;
      option.textContent = formatarMesAno(m);
      selectMes.appendChild(option);
    });
    selectMes.value = mesAtual;
  }

  // Formata "YYYY-MM" para "MM/YYYY"
  function formatarMesAno(mesAno) {
    const [ano, mes] = mesAno.split("-");
    return `${mes}/${ano}`;
  }

  // Formata data ISO para "DD/MM (Dia)"
  function formatarData(dataISO) {
    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
    const d = new Date(dataISO);
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const diaSemana = diasSemana[d.getDay()];
    return `${dia}/${mes} (${diaSemana})`;
  }

  // Formata data para CSV: "DD/MM/YYYY"
  function formatarDataCSV(dataISO) {
    const d = new Date(dataISO);
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const ano = d.getFullYear();
    return `${dia}/${mes}/${ano}`;
  }

  // Carrega dados do mÃªs selecionado
  function carregarDadosMes(mes) {
    const data = localStorage.getItem("mob_" + mes);
    if(data) {
      dadosMes = JSON.parse(data);
    } else {
      dadosMes = { meta: 0, ganhos: [], gastos: [] };
    }
    notificouMeta = false;
    atualizarCampos();
    atualizarResumo();
  }

  // Salva dados do mÃªs atual
  function salvarDadosMes() {
    localStorage.setItem("mob_" + selectMes.value, JSON.stringify(dadosMes));
  }

  function atualizarCampos() {
    metaInput.value = dadosMes.meta > 0 ? dadosMes.meta.toFixed(2) : "";
  }

  function atualizarResumo() {
    const totalGanhos = dadosMes.ganhos.reduce((a,b) => a + b.valor, 0);
    const totalGastos = dadosMes.gastos.reduce((a,b) => a + b.valor, 0);
    const lucroLiquido = totalGanhos - totalGastos;

    totalGanhosSpan.textContent = totalGanhos.toFixed(2);
    totalGastosSpan.textContent = totalGastos.toFixed(2);
    lucroLiquidoSpan.textContent = lucroLiquido.toFixed(2);
    metaExibidaSpan.textContent = dadosMes.meta.toFixed(2);
    diasTrabalhadosSpan.textContent = dadosMes.ganhos.length;

    const progresso = dadosMes.meta > 0 ? Math.min((lucroLiquido / dadosMes.meta) * 100, 100) : 0;
    progressoPercentSpan.textContent = progresso.toFixed(1) + "%";
    progressFillDiv.style.width = progresso + "%";

    if (progresso >= 100 && !notificouMeta) {
      alert("ðŸŽ‰ ParabÃ©ns! VocÃª atingiu sua meta mensal!");
      notificouMeta = true;
    }

    atualizarListas();
  }

  function atualizarListas() {
    // Ganhos
    listaGanhosUl.innerHTML = "";
    dadosMes.ganhos.forEach(({ valor, data }, i) => {
      const li = document.createElement("li");
      li.textContent = `Dia ${formatarData(data)}: R$ ${valor.toFixed(2)}`;
      listaGanhosUl.appendChild(li);
    });

    // Gastos
    listaGastosUl.innerHTML = "";
    dadosMes.gastos.forEach(({ valor, data }, i) => {
      const li = document.createElement("li");
      li.textContent = `Gasto ${formatarData(data)}: R$ ${valor.toFixed(2)}`;
      listaGastosUl.appendChild(li);
    });
  }

  // Eventos

  selectMes.addEventListener("change", () => {
    carregarDadosMes(selectMes.value);
  });

  metaInput.addEventListener("input", () => {
    let val = parseFloat(metaInput.value);
    if (isNaN(val) || val < 0) val = 0;
    dadosMes.meta = val;
    salvarDadosMes();
    notificouMeta = false;
    atualizarResumo();
  });

  btnAdicionar.addEventListener("click", () => {
    let val = parseFloat(valorDiaInput.value);
    if (isNaN(val) || val <= 0) {
      alert("Informe um valor vÃ¡lido para o dia.");
      return;
    }
    const dataAgora = new Date();
    dadosMes.ganhos.push({ valor: val, data: dataAgora.toISOString() });
    valorDiaInput.value = "";
    salvarDadosMes();
    atualizarResumo();
  });

  btnAdicionarGasto.addEventListener("click", () => {
    let val = parseFloat(gastoGasolinaInput.value);
    if (isNaN(val) || val <= 0) {
      alert("Informe um valor vÃ¡lido para o gasto.");
      return;
    }
    const dataAgora = new Date();
    dadosMes.gastos.push({ valor: val, data: dataAgora.toISOString() });
    gastoGasolinaInput.value = "";
    salvarDadosMes();
    atualizarResumo();
  });

  btnLimpar.addEventListener("click", () => {
    if (confirm(`Deseja realmente limpar os dados do mÃªs ${formatarMesAno(selectMes.value)}?`)) {
      localStorage.removeItem("mob_" + selectMes.value);
      carregarDadosMes(selectMes.value);
      popularSelectMes(); // Atualiza lista pois o mÃªs pode ter sido removido
    }
  });

  btnExportar.addEventListener("click", () => {
    exportarCSV();
  });

  function exportarCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";

    // CabeÃ§alho
    csvContent += "Tipo,DescriÃ§Ã£o,Data,Valor\n";

    // Meta
    csvContent += `Meta,Meta Mensal,,${dadosMes.meta.toFixed(2)}\n`;

    // Ganhos
    dadosMes.ganhos.forEach(({ valor, data }, i) => {
      csvContent += `Ganho,Dia ${i + 1},${formatarDataCSV(data)},${valor.toFixed(2)}\n`;
    });

    // Gastos
    dadosMes.gastos.forEach(({ valor, data }, i) => {
      csvContent += `Gasto,Gasto ${i + 1},${formatarDataCSV(data)},${valor.toFixed(2)}\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    const dataAtual = new Date();
    const dataStr = dataAtual.toISOString().slice(0,10);
    link.setAttribute("download", `mob_dados_${selectMes.value}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // InicializaÃ§Ã£o
  popularSelectMes();
  carregarDadosMes(selectMes.value);

</script>

</body>
</html>
